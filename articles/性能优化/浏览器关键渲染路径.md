# 浏览器关键渲染路径

## 一、渲染过程

### 1、构建DOM和CSSOM

DOM和CSSOM是独立的的数据结构。

构建DOM的过程（对应于Chrome DevTool中的parse HTML）：

`Bytes => Characters => Tokens => Nodes => DOM`

构建CSSOM的过程（对应于Chrome DevTool中的Recalculate Style）：

`Bytes => Characters => Tokens => Nodes => CSSOM` 

CSSOM对DOM中的Document接口进行了扩展，可以通过`document.styleSheets`访问。

### 2、构建Render-Tree

接下来，浏览器会把DOM和CSSOM合并成一颗Render-Tree，网罗所有可见DOM。

![](/assets/render-tree-construction.png)

**DOM-Tree和Render-Tree的区别是**：

* Render-Tree没有head、script等不可见标签
* Render-Tree没有display: none的元素
* Render-Tree中增加了CSS伪元素

### 3、Layout、Paint、Composite

Layout过程计算网页中每个元素的大小和位置。Paint过程进行元素绘制。Composite过程组合图层。[引起layout、paint、composite的CSS属性](https://csstriggers.com/)

## 二、防止渲染阻塞

CSS是阻塞资源，需要将它尽早、尽快地下载到客户端，以便缩短首次渲染时间。可以通过media标签尽可能防止阻塞。

    <link href="style.css"    rel="stylesheet">
    <link href="style.css"    rel="stylesheet" media="all">
    <link href="portrait.css" rel="stylesheet" media="orientation:portrait"> // 可能阻塞渲染
    <link href="print.css"    rel="stylesheet" media="print"> // 不会阻塞渲染
    
JavaScript会阻塞CSSOM和DOM构建，`script`标签最好放在CSS之后，可以添加`async`和`defer`属性来优化。[async vs. defer attributes](https://www.growingwiththeweb.com/2014/02/async-vs-defer-attributes.html)

* CSS放在head中
* 避免CSS import
* inline CSS
* 在link标签中合理使用media属性
* JavaScript放在body底部
* async JavaScript
* defer JavaScript
* 避免运行长时间的JavaScript